---
# =============================================================================
# RabbitMQ 4.x Installation Tasks
# =============================================================================

- name: Import RabbitMQ signing key
  ansible.builtin.rpm_key:
    key: https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-server.9F4587F226208342.key
    state: present

- name: Add RabbitMQ server repository
  ansible.builtin.yum_repository:
    name: rabbitmq_server
    description: RabbitMQ Server Repository for RHEL 8
    baseurl: https://yum1.rabbitmq.com/rabbitmq/el/8/$basearch
    gpgcheck: yes
    gpgkey: https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-server.9F4587F226208342.key
    enabled: yes
    repo_gpgcheck: no
    sslverify: yes
    sslcacert: /etc/pki/tls/certs/ca-bundle.crt

- name: Install RabbitMQ server
  ansible.builtin.dnf:
    name:
      - "rabbitmq-server-{{ rabbitmq_version }}*"
    state: present
    enablerepo: rabbitmq_server
  register: rabbitmq_install
  retries: 3
  delay: 10
  until: rabbitmq_install is succeeded

- name: Create RabbitMQ directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: rabbitmq
    group: rabbitmq
    mode: '0755'
  loop:
    - /var/lib/rabbitmq
    - /var/log/rabbitmq
    - /etc/rabbitmq
    - /etc/rabbitmq/conf.d

- name: Create systemd override directory for RabbitMQ
  ansible.builtin.file:
    path: /etc/systemd/system/rabbitmq-server.service.d
    state: directory
    mode: '0755'

- name: Configure system limits for RabbitMQ service
  ansible.builtin.template:
    src: rabbitmq-limits.conf.j2
    dest: /etc/systemd/system/rabbitmq-server.service.d/limits.conf
    mode: '0644'
  notify: Reload systemd

- name: Configure system-wide limits for RabbitMQ user
  ansible.builtin.template:
    src: 99-rabbitmq.conf.j2
    dest: /etc/security/limits.d/99-rabbitmq.conf
    mode: '0644'

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: yes

- name: Enable RabbitMQ service
  ansible.builtin.systemd:
    name: rabbitmq-server
    enabled: yes

- name: Verify RabbitMQ installation
  ansible.builtin.command: rabbitmqctl version
  register: rabbitmq_version_check
  changed_when: false

- name: Display installed RabbitMQ version
  ansible.builtin.debug:
    msg: "RabbitMQ {{ rabbitmq_version_check.stdout | trim }} installed successfully"
