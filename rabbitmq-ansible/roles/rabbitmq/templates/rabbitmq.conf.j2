# =============================================================================
# RabbitMQ Configuration File
# Generated by Ansible - {{ ansible_date_time.iso8601 }}
# Environment: {{ environment_name }}
# Node: {{ inventory_hostname }}
# =============================================================================

# =============================================================================
# Network Configuration
# =============================================================================
listeners.tcp.default = {{ rabbitmq_tcp_listen_port }}

{% if rabbitmq_ssl_enabled %}
# TLS Configuration
listeners.ssl.default = 5671
ssl_options.cacertfile = {{ rabbitmq_ssl_ca_path }}
ssl_options.certfile = {{ rabbitmq_ssl_cert_path }}
ssl_options.keyfile = {{ rabbitmq_ssl_key_path }}
ssl_options.verify = verify_peer
ssl_options.fail_if_no_peer_cert = false
ssl_options.versions.1 = tlsv1.3
ssl_options.versions.2 = tlsv1.2
{% endif %}

# =============================================================================
# Management Plugin Configuration
# =============================================================================
management.tcp.port = {{ rabbitmq_management_port }}
management.tcp.ip = 0.0.0.0
management.cors.allow_origins.1 = *
management.load_definitions = /etc/rabbitmq/definitions.json

# =============================================================================
# Prometheus Metrics
# =============================================================================
prometheus.return_per_object_metrics = true
prometheus.path = /metrics
prometheus.tcp.port = {{ rabbitmq_prometheus_port }}

# =============================================================================
# Cluster Configuration
# =============================================================================
cluster_partition_handling = {{ rabbitmq_cluster_partition_handling }}

# Peer discovery using classic config
cluster_formation.peer_discovery_backend = classic_config
{% for host in groups['rabbitmq_cluster'] %}
cluster_formation.classic_config.nodes.{{ loop.index }} = rabbit@{{ host }}
{% endfor %}

# Node discovery timeout
cluster_formation.discovery_retry_limit = 10
cluster_formation.discovery_retry_interval = 500

# =============================================================================
# Memory and Disk Configuration
# =============================================================================
# Memory threshold (relative to total RAM)
vm_memory_high_watermark.relative = {{ rabbitmq_vm_memory_high_watermark }}

# Paging threshold (when to start paging messages to disk)
vm_memory_high_watermark_paging_ratio = 0.5

# Disk free limit (relative to total RAM)
disk_free_limit.relative = {{ rabbitmq_disk_free_limit_relative }}

# =============================================================================
# Statistics and Metrics
# =============================================================================
collect_statistics_interval = {{ rabbitmq_collect_statistics_interval }}

# =============================================================================
# Logging Configuration
# =============================================================================
log.file.level = {{ rabbitmq_log_level }}
log.console = false
log.console.level = {{ rabbitmq_log_level }}
log.file = /var/log/rabbitmq/rabbit.log

# Log rotation
log.file.rotation.date = $D0
log.file.rotation.count = {{ rabbitmq_log_rotation_count }}

# =============================================================================
# Queue Configuration (RabbitMQ 4.x)
# =============================================================================
# Default queue type for new queues (classic, quorum, stream)
default_queue_type = quorum

# Quorum queue settings
quorum_queue.segment_entry_count = 32768

# Classic queue settings (for backward compatibility)
classic_queue.default_version = 2

# =============================================================================
# Connection and Channel Configuration
# =============================================================================
# Maximum number of channels per connection
channel_max = 2047

# Heartbeat interval (seconds) - 0 disables
heartbeat = 60

# Maximum frame size
frame_max = 131072

# =============================================================================
# Consumer Configuration
# =============================================================================
# Consumer acknowledgement timeout (milliseconds)
# Set to 0 to disable (not recommended for production)
consumer_timeout = 1800000

# =============================================================================
# Authentication Configuration
# =============================================================================
# Default user (disabled after initial setup)
# default_user = guest
# default_pass = guest

# Loopback users (users that can only connect from localhost)
loopback_users = none

# Authentication backends
auth_backends.1 = internal

# =============================================================================
# Background GC Configuration
# =============================================================================
background_gc_enabled = true
background_gc_target_interval = 60000

# =============================================================================
# Virtual Host Metadata
# =============================================================================
default_vhost = {{ rabbitmq_default_vhost }}

# =============================================================================
# Queue and Exchange Defaults
# =============================================================================
# Queue leader locator strategy (client-local, balanced)
queue_leader_locator = balanced

# =============================================================================
# Mirroring Configuration (for classic mirrored queues)
# Note: Quorum queues are preferred in RabbitMQ 4.x
# =============================================================================
# ha-mode and ha-params are configured via policies
