---
# =============================================================================
# RabbitMQ 4.x Cluster Configuration - Production Environment
# =============================================================================

# Environment Identification
environment_name: production
domain_name: example.com

# Erlang Configuration
erlang_version: "26.2"
# CRITICAL: Erlang cookie MUST come from Harness Secrets in production
erlang_cookie: "{{ lookup('env', 'RABBITMQ_ERLANG_COOKIE') }}"

# RabbitMQ Configuration
rabbitmq_version: "4.0.2"
rabbitmq_plugins:
  - rabbitmq_management
  - rabbitmq_prometheus
  - rabbitmq_shovel
  - rabbitmq_shovel_management
  - rabbitmq_federation
  - rabbitmq_federation_management
  - rabbitmq_consistent_hash_exchange

# Credentials (MUST come from Harness Secrets Manager)
rabbitmq_default_vhost: "/"
rabbitmq_default_user: "admin"
rabbitmq_default_pass: "{{ lookup('env', 'RABBITMQ_ADMIN_PASSWORD') }}"
rabbitmq_default_user_tags: "administrator"

# Memory and Disk Configuration (Conservative for Production)
rabbitmq_vm_memory_high_watermark: 0.5
rabbitmq_disk_free_limit_relative: 2.0

# Cluster Configuration
rabbitmq_cluster_partition_handling: pause_minority
rabbitmq_collect_statistics_interval: 10000

# Network Configuration
rabbitmq_tcp_listen_port: 5672
rabbitmq_management_port: 15672
rabbitmq_prometheus_port: 15692

# TLS Configuration (ENABLE for Production)
rabbitmq_ssl_enabled: true
rabbitmq_ssl_cert_path: "/etc/rabbitmq/ssl/cert.pem"
rabbitmq_ssl_key_path: "/etc/rabbitmq/ssl/key.pem"
rabbitmq_ssl_ca_path: "/etc/rabbitmq/ssl/ca.pem"

# Users Configuration
rabbitmq_users:
  - name: admin
    password: "{{ rabbitmq_default_pass }}"
    tags: administrator
    vhost: /
    configure_priv: ".*"
    read_priv: ".*"
    write_priv: ".*"
  - name: monitoring
    password: "{{ lookup('env', 'RABBITMQ_MONITORING_PASSWORD') }}"
    tags: monitoring
    vhost: /
    configure_priv: ""
    read_priv: ".*"
    write_priv: ""
  - name: app_user
    password: "{{ lookup('env', 'RABBITMQ_APP_PASSWORD') }}"
    tags: ""
    vhost: /
    configure_priv: ""
    read_priv: ".*"
    write_priv: ".*"

# Virtual Hosts
rabbitmq_vhosts:
  - name: /
    state: present
  - name: /applications
    state: present
  - name: /monitoring
    state: present

# Policies (Production HA settings)
rabbitmq_policies:
  - name: ha-all
    vhost: /
    pattern: ".*"
    tags:
      ha-mode: all
      ha-sync-mode: automatic
    priority: 0
  - name: ha-applications
    vhost: /applications
    pattern: ".*"
    tags:
      ha-mode: all
      ha-sync-mode: automatic
    priority: 0

# System Limits (Higher for Production)
rabbitmq_ulimit_nofile: 131072
rabbitmq_ulimit_nproc: 131072

# Logging
rabbitmq_log_level: warning
rabbitmq_log_rotation_count: 14
