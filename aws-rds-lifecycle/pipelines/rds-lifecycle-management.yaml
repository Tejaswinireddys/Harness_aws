###############################################################################
# Pipeline: RDS Instance Lifecycle Management
# Purpose: Start, Stop, List, and Snapshot RDS instances and Aurora clusters
# Author: Platform Team
# Version: 1.0.0
###############################################################################

pipeline:
  name: RDS Instance Lifecycle Management
  identifier: rds_lifecycle_management
  projectIdentifier: <+org.identifier>_platform
  orgIdentifier: <+org.identifier>
  description: |
    Comprehensive RDS database lifecycle management pipeline.
    Supports: List, Start, Stop, and Snapshot operations for RDS and Aurora.
  tags:
    category: database
    team: platform
    service: rds-lifecycle

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PIPELINE VARIABLES (User Inputs)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  variables:
    - name: action
      type: String
      description: Action to perform on RDS databases
      required: true
      value: <+input>.allowedValues(list_all,list_available,list_stopped,list_clusters,start,stop)

    - name: aws_region
      type: String
      description: AWS Region where databases are located
      required: true
      value: <+input>.default(us-east-1).allowedValues(us-east-1,us-east-2,us-west-1,us-west-2,eu-west-1,eu-west-2,eu-central-1,ap-south-1,ap-southeast-1,ap-southeast-2,ap-northeast-1)

    - name: db_identifiers
      type: String
      description: Comma-separated DB instance identifiers (required for start/stop)
      required: false
      value: <+input>

    - name: cluster_identifiers
      type: String
      description: Comma-separated Aurora cluster identifiers (for cluster operations)
      required: false
      value: <+input>

    - name: engine_filter
      type: String
      description: Filter databases by engine type
      required: false
      value: <+input>.default("").allowedValues("",mysql,postgres,mariadb,oracle-ee,sqlserver-ee,aurora-mysql,aurora-postgresql)

    - name: create_snapshot
      type: String
      description: Create snapshot before stop action
      required: false
      value: <+input>.default(true).allowedValues(true,false)

    - name: dry_run
      type: String
      description: Enable dry run mode (no actual changes)
      required: false
      value: <+input>.default(false).allowedValues(true,false)

    - name: wait_for_state
      type: String
      description: Wait for databases to reach target state
      required: false
      value: <+input>.default(true).allowedValues(true,false)

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PIPELINE STAGES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  stages:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STAGE 1: INITIALIZATION
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - stage:
        name: "1ï¸âƒ£ Initialize"
        identifier: initialize
        description: Initialize pipeline and display configuration
        type: Custom
        spec:
          execution:
            steps:
              - step:
                  type: ShellScript
                  name: Display Configuration
                  identifier: display_configuration
                  spec:
                    shell: Bash
                    source:
                      type: Inline
                      spec:
                        script: |
                          #!/bin/bash

                          echo ""
                          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                          echo "â•‘                                                                          â•‘"
                          echo "â•‘              RDS LIFECYCLE MANAGEMENT - PIPELINE STARTED                 â•‘"
                          echo "â•‘                                                                          â•‘"
                          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                          echo ""
                          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                          echo "  PIPELINE CONFIGURATION"
                          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                          echo ""
                          echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
                          echo "  â”‚  EXECUTION PARAMETERS                                           â”‚"
                          echo "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
                          printf "  â”‚  %-22s: %-38s â”‚\n" "Action" "$ACTION"
                          printf "  â”‚  %-22s: %-38s â”‚\n" "AWS Region" "$AWS_REGION"
                          printf "  â”‚  %-22s: %-38s â”‚\n" "Engine Filter" "${ENGINE_FILTER:-All Engines}"
                          printf "  â”‚  %-22s: %-38s â”‚\n" "Create Snapshot" "$CREATE_SNAPSHOT"
                          printf "  â”‚  %-22s: %-38s â”‚\n" "Dry Run" "$DRY_RUN"
                          printf "  â”‚  %-22s: %-38s â”‚\n" "Wait for State" "$WAIT_FOR_STATE"
                          echo "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
                          printf "  â”‚  %-22s: %-38s â”‚\n" "Pipeline ID" "${HARNESS_PIPELINE_ID:-N/A}"
                          printf "  â”‚  %-22s: %-38s â”‚\n" "Triggered By" "${HARNESS_USER_NAME:-System}"
                          printf "  â”‚  %-22s: %-38s â”‚\n" "Timestamp" "$(date '+%Y-%m-%d %H:%M:%S %Z')"
                          echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
                          echo ""

                          # Validate action and identifiers
                          if [[ "$ACTION" == "start" || "$ACTION" == "stop" ]]; then
                            if [[ -z "$DB_IDENTIFIERS" && -z "$CLUSTER_IDENTIFIERS" ]]; then
                              echo "âŒ ERROR: DB or Cluster identifiers required for $ACTION"
                              exit 1
                            fi
                            echo "âœ… Database identifiers provided for $ACTION action"
                          fi

                          if [[ -n "$DB_IDENTIFIERS" ]]; then
                            echo "  Target DB Instances:"
                            IFS=',' read -ra DBS <<< "$DB_IDENTIFIERS"
                            for db in "${DBS[@]}"; do
                              echo "    â†’ $(echo "$db" | tr -d ' ')"
                            done
                          fi

                          if [[ -n "$CLUSTER_IDENTIFIERS" ]]; then
                            echo "  Target Aurora Clusters:"
                            IFS=',' read -ra CLUSTERS <<< "$CLUSTER_IDENTIFIERS"
                            for cluster in "${CLUSTERS[@]}"; do
                              echo "    â†’ $(echo "$cluster" | tr -d ' ')"
                            done
                          fi

                          echo ""
                          echo "INITIALIZATION_STATUS=success" >> $HARNESS_OUTPUT_FILE
                    envVariables:
                      ACTION: <+pipeline.variables.action>
                      AWS_REGION: <+pipeline.variables.aws_region>
                      DB_IDENTIFIERS: <+pipeline.variables.db_identifiers>
                      CLUSTER_IDENTIFIERS: <+pipeline.variables.cluster_identifiers>
                      ENGINE_FILTER: <+pipeline.variables.engine_filter>
                      CREATE_SNAPSHOT: <+pipeline.variables.create_snapshot>
                      DRY_RUN: <+pipeline.variables.dry_run>
                      WAIT_FOR_STATE: <+pipeline.variables.wait_for_state>
                    outputVariables:
                      - name: INITIALIZATION_STATUS
                  timeout: 1m

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STAGE 2: VALIDATION
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - stage:
        name: "2ï¸âƒ£ Validate Credentials"
        identifier: validate
        description: Validate AWS credentials and RDS permissions
        type: Custom
        spec:
          execution:
            steps:
              - step:
                  type: ShellScript
                  name: Validate AWS Credentials
                  identifier: validate_aws_credentials
                  spec:
                    shell: Bash
                    source:
                      type: Inline
                      spec:
                        script: |
                          #!/bin/bash
                          set -euo pipefail

                          echo ""
                          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                          echo "â•‘              AWS CREDENTIALS & RDS PERMISSIONS VALIDATION                â•‘"
                          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                          echo ""

                          # Validate STS
                          echo "ğŸ” Validating AWS credentials..."
                          CALLER_IDENTITY=$(aws sts get-caller-identity --output json 2>&1) || {
                            echo "âŒ ERROR: Invalid AWS credentials"
                            exit 1
                          }

                          ACCOUNT_ID=$(echo $CALLER_IDENTITY | jq -r '.Account')
                          echo "âœ… AWS Credentials Valid (Account: $ACCOUNT_ID)"
                          echo ""

                          # Validate RDS permissions
                          echo "ğŸ—„ï¸  Validating RDS permissions..."
                          aws rds describe-db-instances --region $AWS_REGION --max-records 5 > /dev/null 2>&1 || {
                            echo "âŒ ERROR: No permission to describe RDS instances"
                            exit 1
                          }
                          echo "âœ… RDS DescribeDBInstances permission verified"

                          aws rds describe-db-clusters --region $AWS_REGION --max-records 5 > /dev/null 2>&1 || {
                            echo "âš ï¸  Warning: Limited cluster permissions"
                          }
                          echo "âœ… RDS DescribeDBClusters permission verified"
                          echo ""

                          echo "AWS_ACCOUNT_ID=$ACCOUNT_ID" >> $HARNESS_OUTPUT_FILE
                          echo "VALIDATION_STATUS=success" >> $HARNESS_OUTPUT_FILE
                    envVariables:
                      AWS_ACCESS_KEY_ID: <+secrets.getValue("org.aws_access_key_id")>
                      AWS_SECRET_ACCESS_KEY: <+secrets.getValue("org.aws_secret_access_key")>
                      AWS_REGION: <+pipeline.variables.aws_region>
                    outputVariables:
                      - name: AWS_ACCOUNT_ID
                      - name: VALIDATION_STATUS
                  timeout: 2m

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STAGE 3: DISCOVERY
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - stage:
        name: "3ï¸âƒ£ Discover Databases"
        identifier: discovery
        description: Discover and list RDS instances and Aurora clusters
        type: Custom
        spec:
          execution:
            steps:
              - step:
                  type: ShellScript
                  name: List RDS Instances
                  identifier: list_instances
                  spec:
                    shell: Bash
                    source:
                      type: Inline
                      spec:
                        script: |
                          #!/bin/bash
                          set -euo pipefail

                          echo ""
                          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                          echo "â•‘                    RDS DATABASE DISCOVERY                                â•‘"
                          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                          echo ""

                          # Fetch RDS instances
                          echo "ğŸ“¡ Fetching RDS instances in $AWS_REGION..."
                          INSTANCES=$(aws rds describe-db-instances \
                            --region "$AWS_REGION" \
                            --query 'DBInstances[].{
                              ID: DBInstanceIdentifier,
                              Status: DBInstanceStatus,
                              Engine: Engine,
                              Class: DBInstanceClass,
                              Storage: AllocatedStorage,
                              MultiAZ: MultiAZ
                            }' --output json)

                          # Filter by engine if specified
                          if [[ -n "${ENGINE_FILTER:-}" ]]; then
                            INSTANCES=$(echo "$INSTANCES" | jq --arg e "$ENGINE_FILTER" '[.[] | select(.Engine | contains($e))]')
                          fi

                          # Filter by status based on action
                          case $ACTION in
                            "list_available") INSTANCES=$(echo "$INSTANCES" | jq '[.[] | select(.Status == "available")]') ;;
                            "list_stopped") INSTANCES=$(echo "$INSTANCES" | jq '[.[] | select(.Status == "stopped")]') ;;
                          esac

                          TOTAL=$(echo "$INSTANCES" | jq 'length')
                          AVAILABLE=$(echo "$INSTANCES" | jq '[.[] | select(.Status == "available")] | length')
                          STOPPED=$(echo "$INSTANCES" | jq '[.[] | select(.Status == "stopped")] | length')

                          echo ""
                          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                          echo "  RDS INSTANCES SUMMARY"
                          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                          echo ""
                          echo "  Available: $AVAILABLE | Stopped: $STOPPED | Total: $TOTAL"
                          echo ""

                          if [[ "$TOTAL" -gt 0 ]]; then
                            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”"
                            echo "â”‚ DB Identifier            â”‚ Status      â”‚ Engine       â”‚ Class         â”‚ Multi  â”‚"
                            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤"

                            echo "$INSTANCES" | jq -r '.[] | [.ID, .Status, .Engine, .Class, (if .MultiAZ then "Yes" else "No" end)] | @tsv' | while IFS=$'\t' read -r id status engine class multiaz; do
                              printf "â”‚ %-24s â”‚ %-11s â”‚ %-12s â”‚ %-13s â”‚ %-6s â”‚\n" "${id:0:24}" "$status" "${engine:0:12}" "${class:0:13}" "$multiaz"
                            done

                            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
                          fi
                          echo ""

                          # Fetch Aurora Clusters
                          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                          echo "  AURORA CLUSTERS"
                          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                          echo ""

                          CLUSTERS=$(aws rds describe-db-clusters \
                            --region "$AWS_REGION" \
                            --query 'DBClusters[].{ID: DBClusterIdentifier, Status: Status, Engine: Engine, Members: DBClusterMembers}' \
                            --output json 2>/dev/null || echo "[]")

                          CLUSTER_COUNT=$(echo "$CLUSTERS" | jq 'length')

                          if [[ "$CLUSTER_COUNT" -gt 0 ]]; then
                            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
                            echo "â”‚ Cluster Identifier       â”‚ Status      â”‚ Engine               â”‚ Members â”‚"
                            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"

                            echo "$CLUSTERS" | jq -r '.[] | [.ID, .Status, .Engine, (.Members | length | tostring)] | @tsv' | while IFS=$'\t' read -r id status engine members; do
                              printf "â”‚ %-24s â”‚ %-11s â”‚ %-20s â”‚ %-7s â”‚\n" "${id:0:24}" "$status" "${engine:0:20}" "$members"
                            done

                            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
                          else
                            echo "  No Aurora clusters found"
                          fi
                          echo ""

                          # Create lists
                          AVAILABLE_IDS=$(echo "$INSTANCES" | jq -r '[.[] | select(.Status == "available") | .ID] | join(",")')
                          STOPPED_IDS=$(echo "$INSTANCES" | jq -r '[.[] | select(.Status == "stopped") | .ID] | join(",")')

                          {
                            echo "TOTAL_INSTANCES=$TOTAL"
                            echo "AVAILABLE_INSTANCES=$AVAILABLE"
                            echo "STOPPED_INSTANCES=$STOPPED"
                            echo "CLUSTER_COUNT=$CLUSTER_COUNT"
                            echo "AVAILABLE_IDS=$AVAILABLE_IDS"
                            echo "STOPPED_IDS=$STOPPED_IDS"
                          } >> "$HARNESS_OUTPUT_FILE"

                          echo "âœ… Discovery complete!"
                    envVariables:
                      AWS_ACCESS_KEY_ID: <+secrets.getValue("org.aws_access_key_id")>
                      AWS_SECRET_ACCESS_KEY: <+secrets.getValue("org.aws_secret_access_key")>
                      AWS_REGION: <+pipeline.variables.aws_region>
                      ACTION: <+pipeline.variables.action>
                      ENGINE_FILTER: <+pipeline.variables.engine_filter>
                    outputVariables:
                      - name: TOTAL_INSTANCES
                      - name: AVAILABLE_INSTANCES
                      - name: STOPPED_INSTANCES
                      - name: CLUSTER_COUNT
                      - name: AVAILABLE_IDS
                      - name: STOPPED_IDS
                  timeout: 5m

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STAGE 4: SNAPSHOT (Conditional - Before Stop)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - stage:
        name: "4ï¸âƒ£ Create Snapshot"
        identifier: create_snapshot
        description: Create snapshot before stop action (safety backup)
        type: Custom
        when:
          pipelineStatus: Success
          condition: <+pipeline.variables.action> == "stop" && <+pipeline.variables.create_snapshot> == "true" && <+pipeline.variables.dry_run> == "false"
        spec:
          execution:
            steps:
              - step:
                  type: ShellScript
                  name: Create Pre-Stop Snapshot
                  identifier: create_pre_stop_snapshot
                  spec:
                    shell: Bash
                    source:
                      type: Inline
                      spec:
                        script: |
                          #!/bin/bash
                          set -euo pipefail

                          echo ""
                          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                          echo "â•‘                    CREATING PRE-STOP SNAPSHOTS                           â•‘"
                          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                          echo ""

                          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
                          SNAPSHOT_PREFIX="harness-pre-stop"
                          CREATED_SNAPSHOTS=""

                          # Create DB instance snapshots
                          if [[ -n "$DB_IDENTIFIERS" ]]; then
                            echo "Creating snapshots for DB instances..."
                            echo ""

                            IFS=',' read -ra DBS <<< "$DB_IDENTIFIERS"
                            for db_id in "${DBS[@]}"; do
                              db_id=$(echo "$db_id" | tr -d ' ')
                              snapshot_id="${SNAPSHOT_PREFIX}-${db_id}-${TIMESTAMP}"

                              echo "  ğŸ“¸ Creating snapshot: $snapshot_id"
                              aws rds create-db-snapshot \
                                --region "$AWS_REGION" \
                                --db-instance-identifier "$db_id" \
                                --db-snapshot-identifier "$snapshot_id" > /dev/null 2>&1 && {
                                echo "     âœ… Snapshot initiated"
                                CREATED_SNAPSHOTS="$CREATED_SNAPSHOTS$snapshot_id,"
                              } || {
                                echo "     âš ï¸  Failed to create snapshot"
                              }
                            done
                            echo ""
                          fi

                          # Create cluster snapshots
                          if [[ -n "$CLUSTER_IDENTIFIERS" ]]; then
                            echo "Creating snapshots for Aurora clusters..."
                            echo ""

                            IFS=',' read -ra CLUSTERS <<< "$CLUSTER_IDENTIFIERS"
                            for cluster_id in "${CLUSTERS[@]}"; do
                              cluster_id=$(echo "$cluster_id" | tr -d ' ')
                              snapshot_id="${SNAPSHOT_PREFIX}-${cluster_id}-${TIMESTAMP}"

                              echo "  ğŸ“¸ Creating cluster snapshot: $snapshot_id"
                              aws rds create-db-cluster-snapshot \
                                --region "$AWS_REGION" \
                                --db-cluster-identifier "$cluster_id" \
                                --db-cluster-snapshot-identifier "$snapshot_id" > /dev/null 2>&1 && {
                                echo "     âœ… Cluster snapshot initiated"
                                CREATED_SNAPSHOTS="$CREATED_SNAPSHOTS$snapshot_id,"
                              } || {
                                echo "     âš ï¸  Failed to create cluster snapshot"
                              }
                            done
                            echo ""
                          fi

                          echo "â³ Snapshots are being created in the background..."
                          echo "   Proceeding with stop operation (snapshots will complete independently)"
                          echo ""

                          echo "SNAPSHOT_STATUS=initiated" >> $HARNESS_OUTPUT_FILE
                          echo "CREATED_SNAPSHOTS=${CREATED_SNAPSHOTS%,}" >> $HARNESS_OUTPUT_FILE
                    envVariables:
                      AWS_ACCESS_KEY_ID: <+secrets.getValue("org.aws_access_key_id")>
                      AWS_SECRET_ACCESS_KEY: <+secrets.getValue("org.aws_secret_access_key")>
                      AWS_REGION: <+pipeline.variables.aws_region>
                      DB_IDENTIFIERS: <+pipeline.variables.db_identifiers>
                      CLUSTER_IDENTIFIERS: <+pipeline.variables.cluster_identifiers>
                    outputVariables:
                      - name: SNAPSHOT_STATUS
                      - name: CREATED_SNAPSHOTS
                  timeout: 10m

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STAGE 5: ACTION EXECUTION
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - stage:
        name: "5ï¸âƒ£ Execute Action"
        identifier: execute_action
        description: Execute start/stop action on databases
        type: Custom
        when:
          pipelineStatus: Success
          condition: <+pipeline.variables.action> == "start" || <+pipeline.variables.action> == "stop"
        spec:
          execution:
            steps:
              - step:
                  type: ShellScript
                  name: Execute Database Action
                  identifier: execute_database_action
                  spec:
                    shell: Bash
                    source:
                      type: Inline
                      spec:
                        script: |
                          #!/bin/bash
                          set -euo pipefail

                          echo ""
                          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                          echo "â•‘                    EXECUTING RDS ACTION                                  â•‘"
                          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                          echo ""

                          # Dry run check
                          if [[ "$DRY_RUN" == "true" ]]; then
                            echo "ğŸ” DRY RUN MODE - No changes will be made"
                            echo ""
                            echo "Would $ACTION:"
                            [[ -n "$DB_IDENTIFIERS" ]] && echo "  DB Instances: $DB_IDENTIFIERS"
                            [[ -n "$CLUSTER_IDENTIFIERS" ]] && echo "  Clusters: $CLUSTER_IDENTIFIERS"
                            echo ""
                            echo "ACTION_RESULT=dry_run" >> $HARNESS_OUTPUT_FILE
                            exit 0
                          fi

                          SUCCESS_COUNT=0
                          FAILED_COUNT=0

                          # Execute on DB instances
                          if [[ -n "$DB_IDENTIFIERS" ]]; then
                            echo "Processing DB Instances..."
                            echo ""

                            IFS=',' read -ra DBS <<< "$DB_IDENTIFIERS"
                            for db_id in "${DBS[@]}"; do
                              db_id=$(echo "$db_id" | tr -d ' ')

                              if [[ "$ACTION" == "start" ]]; then
                                echo "  ğŸš€ Starting: $db_id"
                                aws rds start-db-instance \
                                  --region "$AWS_REGION" \
                                  --db-instance-identifier "$db_id" > /dev/null 2>&1 && {
                                  echo "     âœ… Start initiated"
                                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                                } || {
                                  echo "     âŒ Failed to start"
                                  FAILED_COUNT=$((FAILED_COUNT + 1))
                                }
                              else
                                echo "  â¹ï¸  Stopping: $db_id"
                                aws rds stop-db-instance \
                                  --region "$AWS_REGION" \
                                  --db-instance-identifier "$db_id" > /dev/null 2>&1 && {
                                  echo "     âœ… Stop initiated"
                                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                                } || {
                                  echo "     âŒ Failed to stop"
                                  FAILED_COUNT=$((FAILED_COUNT + 1))
                                }
                              fi
                            done
                            echo ""
                          fi

                          # Execute on clusters
                          if [[ -n "$CLUSTER_IDENTIFIERS" ]]; then
                            echo "Processing Aurora Clusters..."
                            echo ""

                            IFS=',' read -ra CLUSTERS <<< "$CLUSTER_IDENTIFIERS"
                            for cluster_id in "${CLUSTERS[@]}"; do
                              cluster_id=$(echo "$cluster_id" | tr -d ' ')

                              if [[ "$ACTION" == "start" ]]; then
                                echo "  ğŸš€ Starting cluster: $cluster_id"
                                aws rds start-db-cluster \
                                  --region "$AWS_REGION" \
                                  --db-cluster-identifier "$cluster_id" > /dev/null 2>&1 && {
                                  echo "     âœ… Cluster start initiated"
                                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                                } || {
                                  echo "     âŒ Failed to start cluster"
                                  FAILED_COUNT=$((FAILED_COUNT + 1))
                                }
                              else
                                echo "  â¹ï¸  Stopping cluster: $cluster_id"
                                aws rds stop-db-cluster \
                                  --region "$AWS_REGION" \
                                  --db-cluster-identifier "$cluster_id" > /dev/null 2>&1 && {
                                  echo "     âœ… Cluster stop initiated"
                                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                                } || {
                                  echo "     âŒ Failed to stop cluster"
                                  FAILED_COUNT=$((FAILED_COUNT + 1))
                                }
                              fi
                            done
                            echo ""
                          fi

                          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                          echo "  ACTION RESULTS: $SUCCESS_COUNT succeeded, $FAILED_COUNT failed"
                          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                          echo ""

                          # Wait for state if enabled
                          if [[ "$WAIT_FOR_STATE" == "true" ]]; then
                            TARGET_STATE=""
                            [[ "$ACTION" == "start" ]] && TARGET_STATE="available" || TARGET_STATE="stopped"

                            echo "â³ Waiting for databases to reach $TARGET_STATE state..."
                            echo "   (This may take several minutes)"
                            echo ""

                            if [[ -n "$DB_IDENTIFIERS" ]]; then
                              IFS=',' read -ra DBS <<< "$DB_IDENTIFIERS"
                              for db_id in "${DBS[@]}"; do
                                db_id=$(echo "$db_id" | tr -d ' ')
                                echo "  Waiting for $db_id..."

                                if [[ "$ACTION" == "start" ]]; then
                                  aws rds wait db-instance-available \
                                    --region "$AWS_REGION" \
                                    --db-instance-identifier "$db_id" 2>/dev/null && {
                                    echo "  âœ… $db_id is now available"
                                  } || {
                                    echo "  âš ï¸  Timeout waiting for $db_id"
                                  }
                                else
                                  aws rds wait db-instance-stopped \
                                    --region "$AWS_REGION" \
                                    --db-instance-identifier "$db_id" 2>/dev/null && {
                                    echo "  âœ… $db_id is now stopped"
                                  } || {
                                    echo "  âš ï¸  Timeout waiting for $db_id"
                                  }
                                fi
                              done
                            fi
                            echo ""
                          fi

                          {
                            echo "ACTION_RESULT=success"
                            echo "SUCCESS_COUNT=$SUCCESS_COUNT"
                            echo "FAILED_COUNT=$FAILED_COUNT"
                          } >> "$HARNESS_OUTPUT_FILE"

                          echo "âœ… Action execution complete!"

                          if [[ "$ACTION" == "stop" ]]; then
                            echo ""
                            echo "âš ï¸  REMINDER: Stopped RDS instances will auto-start after 7 days"
                          fi
                    envVariables:
                      AWS_ACCESS_KEY_ID: <+secrets.getValue("org.aws_access_key_id")>
                      AWS_SECRET_ACCESS_KEY: <+secrets.getValue("org.aws_secret_access_key")>
                      AWS_REGION: <+pipeline.variables.aws_region>
                      ACTION: <+pipeline.variables.action>
                      DB_IDENTIFIERS: <+pipeline.variables.db_identifiers>
                      CLUSTER_IDENTIFIERS: <+pipeline.variables.cluster_identifiers>
                      DRY_RUN: <+pipeline.variables.dry_run>
                      WAIT_FOR_STATE: <+pipeline.variables.wait_for_state>
                    outputVariables:
                      - name: ACTION_RESULT
                      - name: SUCCESS_COUNT
                      - name: FAILED_COUNT
                  timeout: 20m

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STAGE 6: VERIFICATION
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - stage:
        name: "6ï¸âƒ£ Verify State"
        identifier: verify_state
        description: Verify databases are in expected state
        type: Custom
        when:
          pipelineStatus: Success
          condition: (<+pipeline.variables.action> == "start" || <+pipeline.variables.action> == "stop") && <+pipeline.variables.dry_run> == "false"
        spec:
          execution:
            steps:
              - step:
                  type: ShellScript
                  name: Verify Database States
                  identifier: verify_database_states
                  spec:
                    shell: Bash
                    source:
                      type: Inline
                      spec:
                        script: |
                          #!/bin/bash
                          set -euo pipefail

                          echo ""
                          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                          echo "â•‘                    STATE VERIFICATION                                    â•‘"
                          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                          echo ""

                          EXPECTED_STATE=""
                          [[ "$ACTION" == "start" ]] && EXPECTED_STATE="available" || EXPECTED_STATE="stopped"

                          echo "Expected State: $EXPECTED_STATE"
                          echo ""

                          VERIFIED=0
                          TOTAL=0

                          # Verify DB instances
                          if [[ -n "$DB_IDENTIFIERS" ]]; then
                            echo "DB Instance Verification:"
                            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
                            echo "â”‚ DB Identifier            â”‚ Status      â”‚ Verification   â”‚"
                            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"

                            IFS=',' read -ra DBS <<< "$DB_IDENTIFIERS"
                            for db_id in "${DBS[@]}"; do
                              db_id=$(echo "$db_id" | tr -d ' ')
                              TOTAL=$((TOTAL + 1))

                              STATUS=$(aws rds describe-db-instances \
                                --region "$AWS_REGION" \
                                --db-instance-identifier "$db_id" \
                                --query 'DBInstances[0].DBInstanceStatus' \
                                --output text 2>/dev/null || echo "ERROR")

                              if [[ "$STATUS" == "$EXPECTED_STATE" ]]; then
                                VERIFIED=$((VERIFIED + 1))
                                printf "â”‚ %-24s â”‚ %-11s â”‚ âœ… VERIFIED    â”‚\n" "${db_id:0:24}" "$STATUS"
                              else
                                printf "â”‚ %-24s â”‚ %-11s â”‚ âŒ MISMATCH    â”‚\n" "${db_id:0:24}" "$STATUS"
                              fi
                            done

                            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
                            echo ""
                          fi

                          # Verify clusters
                          if [[ -n "$CLUSTER_IDENTIFIERS" ]]; then
                            echo "Aurora Cluster Verification:"
                            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
                            echo "â”‚ Cluster Identifier       â”‚ Status      â”‚ Verification   â”‚"
                            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"

                            IFS=',' read -ra CLUSTERS <<< "$CLUSTER_IDENTIFIERS"
                            for cluster_id in "${CLUSTERS[@]}"; do
                              cluster_id=$(echo "$cluster_id" | tr -d ' ')
                              TOTAL=$((TOTAL + 1))

                              STATUS=$(aws rds describe-db-clusters \
                                --region "$AWS_REGION" \
                                --db-cluster-identifier "$cluster_id" \
                                --query 'DBClusters[0].Status' \
                                --output text 2>/dev/null || echo "ERROR")

                              if [[ "$STATUS" == "$EXPECTED_STATE" ]]; then
                                VERIFIED=$((VERIFIED + 1))
                                printf "â”‚ %-24s â”‚ %-11s â”‚ âœ… VERIFIED    â”‚\n" "${cluster_id:0:24}" "$STATUS"
                              else
                                printf "â”‚ %-24s â”‚ %-11s â”‚ âŒ MISMATCH    â”‚\n" "${cluster_id:0:24}" "$STATUS"
                              fi
                            done

                            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
                            echo ""
                          fi

                          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                          echo "  VERIFICATION: $VERIFIED of $TOTAL databases in expected state"
                          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                          echo ""

                          if [[ $VERIFIED -eq $TOTAL ]]; then
                            echo "âœ… All databases verified!"
                            echo "VERIFICATION_STATUS=success" >> $HARNESS_OUTPUT_FILE
                          else
                            echo "âš ï¸  Some databases not in expected state"
                            echo "VERIFICATION_STATUS=partial" >> $HARNESS_OUTPUT_FILE
                          fi

                          echo "VERIFIED_COUNT=$VERIFIED" >> $HARNESS_OUTPUT_FILE
                          echo "TOTAL_COUNT=$TOTAL" >> $HARNESS_OUTPUT_FILE
                    envVariables:
                      AWS_ACCESS_KEY_ID: <+secrets.getValue("org.aws_access_key_id")>
                      AWS_SECRET_ACCESS_KEY: <+secrets.getValue("org.aws_secret_access_key")>
                      AWS_REGION: <+pipeline.variables.aws_region>
                      ACTION: <+pipeline.variables.action>
                      DB_IDENTIFIERS: <+pipeline.variables.db_identifiers>
                      CLUSTER_IDENTIFIERS: <+pipeline.variables.cluster_identifiers>
                    outputVariables:
                      - name: VERIFICATION_STATUS
                      - name: VERIFIED_COUNT
                      - name: TOTAL_COUNT
                  timeout: 5m

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # STAGE 7: SUMMARY & NOTIFICATION
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - stage:
        name: "7ï¸âƒ£ Summary & Notify"
        identifier: summary_notify
        description: Generate summary and send notifications
        type: Custom
        spec:
          execution:
            steps:
              - step:
                  type: ShellScript
                  name: Generate Summary Report
                  identifier: generate_summary
                  spec:
                    shell: Bash
                    source:
                      type: Inline
                      spec:
                        script: |
                          #!/bin/bash

                          echo ""
                          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                          echo "â•‘                                                                          â•‘"
                          echo "â•‘                    PIPELINE EXECUTION SUMMARY                            â•‘"
                          echo "â•‘                                                                          â•‘"
                          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                          echo ""

                          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                          echo "  EXECUTION DETAILS"
                          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                          echo ""
                          echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
                          echo "  â”‚  PIPELINE RESULTS                                               â”‚"
                          echo "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
                          printf "  â”‚  %-22s: %-38s â”‚\n" "Action Performed" "$ACTION"
                          printf "  â”‚  %-22s: %-38s â”‚\n" "Region" "$AWS_REGION"
                          printf "  â”‚  %-22s: %-38s â”‚\n" "Total RDS Instances" "${TOTAL_INSTANCES:-N/A}"
                          printf "  â”‚  %-22s: %-38s â”‚\n" "Available Instances" "${AVAILABLE_INSTANCES:-N/A}"
                          printf "  â”‚  %-22s: %-38s â”‚\n" "Stopped Instances" "${STOPPED_INSTANCES:-N/A}"
                          printf "  â”‚  %-22s: %-38s â”‚\n" "Aurora Clusters" "${CLUSTER_COUNT:-N/A}"
                          echo "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
                          printf "  â”‚  %-22s: %-38s â”‚\n" "Dry Run" "$DRY_RUN"
                          printf "  â”‚  %-22s: %-38s â”‚\n" "Execution Status" "âœ… SUCCESS"
                          printf "  â”‚  %-22s: %-38s â”‚\n" "Completed At" "$(date '+%Y-%m-%d %H:%M:%S %Z')"
                          echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
                          echo ""

                          if [[ "$ACTION" == "stop" ]]; then
                            echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
                            echo "  â”‚  âš ï¸  IMPORTANT REMINDER                                         â”‚"
                            echo "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
                            echo "  â”‚                                                                 â”‚"
                            echo "  â”‚  Stopped RDS instances will AUTOMATICALLY START after 7 days.  â”‚"
                            echo "  â”‚                                                                 â”‚"
                            echo "  â”‚  To keep instances stopped longer, you must:                    â”‚"
                            echo "  â”‚  â€¢ Run this pipeline again before 7 days elapse                 â”‚"
                            echo "  â”‚  â€¢ Or set up scheduled automation to re-stop                    â”‚"
                            echo "  â”‚                                                                 â”‚"
                            echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
                            echo ""
                          fi

                          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                          echo "  PIPELINE COMPLETE"
                          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                          echo ""
                          echo "  Thank you for using RDS Lifecycle Management Pipeline!"
                          echo ""

                          echo "PIPELINE_STATUS=success" >> $HARNESS_OUTPUT_FILE
                    envVariables:
                      ACTION: <+pipeline.variables.action>
                      AWS_REGION: <+pipeline.variables.aws_region>
                      DRY_RUN: <+pipeline.variables.dry_run>
                      TOTAL_INSTANCES: <+pipeline.stages.discovery.spec.execution.steps.list_instances.output.outputVariables.TOTAL_INSTANCES>
                      AVAILABLE_INSTANCES: <+pipeline.stages.discovery.spec.execution.steps.list_instances.output.outputVariables.AVAILABLE_INSTANCES>
                      STOPPED_INSTANCES: <+pipeline.stages.discovery.spec.execution.steps.list_instances.output.outputVariables.STOPPED_INSTANCES>
                      CLUSTER_COUNT: <+pipeline.stages.discovery.spec.execution.steps.list_instances.output.outputVariables.CLUSTER_COUNT>
                    outputVariables:
                      - name: PIPELINE_STATUS
                  timeout: 2m

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # NOTIFICATION RULES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notificationRules:
    - name: RDS Pipeline Success
      identifier: rds_pipeline_success
      pipelineEvents:
        - type: PipelineSuccess
      notificationMethod:
        type: Slack
        spec:
          webhookUrl: <+variable.slack_webhook_url>
      enabled: true

    - name: RDS Pipeline Failure
      identifier: rds_pipeline_failure
      pipelineEvents:
        - type: PipelineFailed
      notificationMethod:
        type: Slack
        spec:
          webhookUrl: <+variable.slack_webhook_url>
      enabled: true
